# KYX 签到系统问题诊断与解决方案

## 问题现象
用户点击签到按钮后，签到失败，浏览器控制台显示错误信息。

## 可能的原因分析

### 1. 数据库表不存在或结构不匹配
**症状**: 控制台显示 SQL 错误，如 "no such table" 或 "no such column"
**解决方案**: 
- 确保所有必要的数据库表已创建
- 运行数据库初始化脚本

### 2. 兑换码库存不足
**症状**: 签到成功但显示"兑换码待管理员分配"
**解决方案**: 
- 使用 `generate-codes.js` 生成兑换码
- 将生成的 SQL 语句在数据库中执行

### 3. 用户会话问题
**症状**: 显示"未登录"或"会话无效"
**解决方案**: 
- 重新登录系统
- 检查 Cookie 设置
- 确保 OAuth 配置正确

### 4. 签到奖励配置缺失
**症状**: 签到时计算奖励失败
**解决方案**: 
- 确保 `checkin_rewards` 表有默认配置
- 检查奖励配置是否激活

## 诊断步骤

### 步骤 1: 使用调试工具
1. 打开 `debug-checkin.html` 页面
2. 点击"检查系统状态"按钮
3. 查看数据库表状态和配置信息

### 步骤 2: 检查数据库表
确保以下表存在且有数据：
- `users` - 用户表
- `sessions` - 会话表  
- `check_ins` - 签到记录表
- `redemption_codes` - 兑换码表
- `checkin_rewards` - 签到奖励配置表

### 步骤 3: 检查兑换码库存
```sql
SELECT COUNT(*) as available_codes 
FROM redemption_codes 
WHERE is_distributed = FALSE;
```

### 步骤 4: 检查签到奖励配置
```sql
SELECT * FROM checkin_rewards 
WHERE is_active = TRUE 
ORDER BY condition_value ASC;
```

## 快速修复方案

### 方案 1: 重新初始化数据库
1. 访问任意页面触发数据库初始化
2. 检查控制台日志确认初始化成功

### 方案 2: 生成兑换码
1. 运行 `node generate-codes.js`
2. 复制生成的 SQL 语句
3. 在数据库中执行 SQL 语句

### 方案 3: 手动添加签到奖励配置
```sql
INSERT OR IGNORE INTO checkin_rewards (reward_type, condition_value, amount, description) VALUES
('base', 0, 1.00, '基础签到奖励'),
('consecutive', 7, 0.50, '连续签到7天奖励'),
('consecutive', 15, 1.00, '连续签到15天奖励'),
('consecutive', 30, 2.00, '连续签到30天奖励');
```

## 常见错误及解决方法

### 错误 1: "no such table: check_ins"
**原因**: 数据库表未创建
**解决**: 重新部署 Workers 脚本，触发数据库初始化

### 错误 2: "签到失败: 未登录"
**原因**: 用户会话过期或无效
**解决**: 重新登录系统

### 错误 3: "兑换码待管理员分配"
**原因**: 没有可用的兑换码
**解决**: 生成并添加兑换码到数据库

### 错误 4: "计算签到奖励失败"
**原因**: 签到奖励配置表为空
**解决**: 添加默认的奖励配置

## 预防措施

1. **定期检查兑换码库存**: 设置监控，当可用兑换码少于某个阈值时发出警告
2. **备份数据库**: 定期备份重要数据
3. **监控错误日志**: 设置日志监控，及时发现问题
4. **测试环境验证**: 在测试环境中验证所有功能正常

## 联系支持

如果以上方案都无法解决问题，请提供以下信息：
1. 浏览器控制台的完整错误信息
2. `debug-checkin.html` 页面的检查结果
3. 用户操作的详细步骤
4. 问题发生的时间和频率

## 更新日志

- 2024-01-XX: 添加了详细的调试工具和错误处理
- 2024-01-XX: 改进了数据库初始化流程
- 2024-01-XX: 增加了兑换码生成脚本
