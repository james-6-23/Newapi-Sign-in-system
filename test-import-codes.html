<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>兑换码导入功能测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
        }
        .btn:hover {
            background: #5a67d8;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .import-modes {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .import-panel {
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .hidden {
            display: none;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 4px solid #28a745;
        }
        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>兑换码导入功能测试</h1>
        <p>这个页面用于测试新的兑换码导入功能，包括文本导入和文件上传两种方式。</p>
        
        <div class="form-group">
            <label>兑换码金额 ($)</label>
            <input type="number" step="0.01" id="importAmount" min="0.01" value="10.00" placeholder="请输入兑换码金额">
        </div>
        
        <div class="import-modes">
            <button class="btn" id="textImportBtn" onclick="switchImportMode('text')">文本导入</button>
            <button class="btn btn-secondary" id="fileImportBtn" onclick="switchImportMode('file')">文件上传</button>
        </div>
        
        <!-- 文本导入面板 -->
        <div id="textImportPanel" class="import-panel">
            <h3>文本导入</h3>
            <div class="form-group">
                <label>兑换码列表（每行一个）</label>
                <textarea id="codesTextarea" rows="10" placeholder="请粘贴兑换码，每行一个&#10;例如：&#10;ABC123DEF456&#10;XYZ789GHI012&#10;TEST001CODE&#10;SAMPLE002CODE"></textarea>
            </div>
            <button class="btn" onclick="doTextImport()">导入兑换码</button>
        </div>
        
        <!-- 文件上传面板 -->
        <div id="fileImportPanel" class="import-panel hidden">
            <h3>文件上传</h3>
            <div class="form-group">
                <label>选择文件（支持.txt格式）</label>
                <input type="file" id="codesFile" accept=".txt">
                <small style="color: #6c757d;">文件格式：每行一个兑换码</small>
            </div>
            <button class="btn" onclick="doFileImport()">上传并导入</button>
        </div>
        
        <div id="result"></div>
    </div>

    <script>
        // 切换导入模式
        function switchImportMode(mode) {
            const textBtn = document.getElementById('textImportBtn');
            const fileBtn = document.getElementById('fileImportBtn');
            const textPanel = document.getElementById('textImportPanel');
            const filePanel = document.getElementById('fileImportPanel');
            
            if (mode === 'text') {
                textBtn.className = 'btn';
                fileBtn.className = 'btn btn-secondary';
                textPanel.classList.remove('hidden');
                filePanel.classList.add('hidden');
            } else {
                textBtn.className = 'btn btn-secondary';
                fileBtn.className = 'btn';
                textPanel.classList.add('hidden');
                filePanel.classList.remove('hidden');
            }
        }

        // 文本导入
        function doTextImport() {
            const amount = parseFloat(document.getElementById('importAmount').value);
            const codesText = document.getElementById('codesTextarea').value.trim();
            
            if (!amount || amount <= 0) {
                showResult('请输入有效的金额', true);
                return;
            }
            
            if (!codesText) {
                showResult('请输入兑换码', true);
                return;
            }
            
            const codes = codesText.split('\n').map(code => code.trim()).filter(code => code);
            
            if (codes.length === 0) {
                showResult('没有有效的兑换码', true);
                return;
            }
            
            // 模拟导入过程
            simulateImport(codes, amount, 'text');
        }

        // 文件导入
        async function doFileImport() {
            const amount = parseFloat(document.getElementById('importAmount').value);
            const fileInput = document.getElementById('codesFile');
            
            if (!amount || amount <= 0) {
                showResult('请输入有效的金额', true);
                return;
            }
            
            if (!fileInput.files || fileInput.files.length === 0) {
                showResult('请选择文件', true);
                return;
            }
            
            const file = fileInput.files[0];
            
            if (!file.name.toLowerCase().endsWith('.txt')) {
                showResult('只支持.txt格式文件', true);
                return;
            }
            
            try {
                const text = await readFileAsText(file);
                const codes = text.split('\n').map(code => code.trim()).filter(code => code);
                
                if (codes.length === 0) {
                    showResult('文件中没有有效的兑换码', true);
                    return;
                }
                
                // 模拟导入过程
                simulateImport(codes, amount, 'file');
            } catch (error) {
                showResult('读取文件失败: ' + error.message, true);
            }
        }

        // 读取文件内容
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(new Error('文件读取失败'));
                reader.readAsText(file, 'UTF-8');
            });
        }

        // 模拟导入过程
        function simulateImport(codes, amount, importType) {
            // 模拟验证和导入逻辑
            let successCount = 0;
            let duplicateCount = 0;
            let invalidCount = 0;
            
            codes.forEach(code => {
                if (code.length < 6 || code.length > 32) {
                    invalidCount++;
                } else if (Math.random() < 0.1) { // 10%概率重复
                    duplicateCount++;
                } else {
                    successCount++;
                }
            });
            
            const message = `导入完成：成功${successCount}个，重复${duplicateCount}个，无效${invalidCount}个`;
            const details = `
                <strong>导入结果：</strong><br>
                • 导入方式：${importType === 'text' ? '文本导入' : '文件上传'}<br>
                • 兑换码金额：$${amount.toFixed(2)}<br>
                • 总数量：${codes.length}<br>
                • 成功导入：${successCount}<br>
                • 重复跳过：${duplicateCount}<br>
                • 格式无效：${invalidCount}
            `;
            
            showResult(message + '<br><br>' + details, false);
        }

        // 显示结果
        function showResult(message, isError) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = message;
            resultDiv.className = isError ? 'result error' : 'result';
        }
    </script>
</body>
</html>
