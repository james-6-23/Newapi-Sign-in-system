<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†åå°æµ‹è¯•é¡µé¢</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f0f;
            color: #ffffff;
            padding: 2rem;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .section {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .section h2 {
            margin-bottom: 1rem;
            color: #0066cc;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            background: #0f0f0f;
            border: 1px solid #333;
            color: #fff;
            padding: 0.75rem;
            border-radius: 8px;
            outline: none;
        }
        .form-group input:focus, .form-group textarea:focus {
            border-color: #0066cc;
        }
        .btn {
            background: #0066cc;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 1rem;
            margin-bottom: 0.5rem;
            transition: opacity 0.2s;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .btn-secondary {
            background: #666;
        }
        .btn-success {
            background: #10b981;
        }
        .btn-danger {
            background: #ef4444;
        }
        .result {
            background: #0f0f0f;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-family: monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        .error {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        .info {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ KYX ç®¡ç†åå°æµ‹è¯•å·¥å…·</h1>
        <p>è¿™ä¸ªé¡µé¢å¯ä»¥å¸®åŠ©ä½ æµ‹è¯•ç®¡ç†åå°çš„å„ç§åŠŸèƒ½ã€‚</p>

        <!-- åŸºæœ¬é…ç½® -->
        <div class="section">
            <h2>âš™ï¸ åŸºæœ¬é…ç½®</h2>
            <div class="form-group">
                <label for="baseUrl">ç®¡ç†åå°åœ°å€:</label>
                <input type="text" id="baseUrl" value="https://your-admin-worker.workers.dev" placeholder="è¾“å…¥ä½ çš„ç®¡ç†åå°åœ°å€">
            </div>
            <div class="form-group">
                <label for="username">ç”¨æˆ·å:</label>
                <input type="text" id="username" value="admin" placeholder="ç®¡ç†å‘˜ç”¨æˆ·å">
            </div>
            <div class="form-group">
                <label for="password">å¯†ç :</label>
                <input type="password" id="password" value="admin123" placeholder="ç®¡ç†å‘˜å¯†ç ">
            </div>
        </div>

        <!-- ç™»å½•æµ‹è¯• -->
        <div class="section">
            <h2>ğŸ” ç™»å½•æµ‹è¯•</h2>
            <button class="btn" onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
            <button class="btn btn-secondary" onclick="testLogout()">æµ‹è¯•ç™»å‡º</button>
            <div id="loginResult" class="result" style="display: none;"></div>
        </div>

        <!-- API æµ‹è¯• -->
        <div class="section">
            <h2>ğŸ“Š API æµ‹è¯•</h2>
            <button class="btn" onclick="testStats()">è·å–ç»Ÿè®¡æ•°æ®</button>
            <button class="btn" onclick="testCodes()">è·å–å…‘æ¢ç åˆ—è¡¨</button>
            <button class="btn" onclick="testUsers()">è·å–ç”¨æˆ·åˆ—è¡¨</button>
            <button class="btn" onclick="testCheckins()">è·å–ç­¾åˆ°è®°å½•</button>
            <div id="apiResult" class="result" style="display: none;"></div>
        </div>

        <!-- æœç´¢æµ‹è¯• -->
        <div class="section">
            <h2>ğŸ” æœç´¢æµ‹è¯•</h2>
            <div class="form-group">
                <label for="searchQuery">æœç´¢å…³é”®è¯:</label>
                <input type="text" id="searchQuery" value="TEST" placeholder="è¾“å…¥è¦æœç´¢çš„å…‘æ¢ç ">
            </div>
            <button class="btn" onclick="testSearch()">æœç´¢å…‘æ¢ç </button>
            <div id="searchResult" class="result" style="display: none;"></div>
        </div>

        <!-- å¯†ç ç”Ÿæˆå·¥å…· -->
        <div class="section">
            <h2>ğŸ”‘ å¯†ç ç”Ÿæˆå·¥å…·</h2>
            <div class="form-group">
                <label for="newUsername">æ–°ç”¨æˆ·å:</label>
                <input type="text" id="newUsername" value="testadmin" placeholder="è¾“å…¥æ–°ç®¡ç†å‘˜ç”¨æˆ·å">
            </div>
            <div class="form-group">
                <label for="newPassword">æ–°å¯†ç :</label>
                <input type="text" id="newPassword" value="SecurePass123!" placeholder="è¾“å…¥æ–°å¯†ç ">
            </div>
            <button class="btn btn-success" onclick="generatePassword()">ç”Ÿæˆå¯†ç å“ˆå¸Œ</button>
            <div id="passwordResult" class="result" style="display: none;"></div>
        </div>

        <!-- é¡µé¢æµ‹è¯• -->
        <div class="section">
            <h2>ğŸŒ é¡µé¢æµ‹è¯•</h2>
            <button class="btn" onclick="openLoginPage()">æ‰“å¼€ç™»å½•é¡µé¢</button>
            <button class="btn" onclick="openAdminPage()">æ‰“å¼€ç®¡ç†é¡µé¢</button>
            <div id="pageResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        let sessionCookie = '';

        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `result ${type}`;
            element.textContent = content;
        }

        function getBaseUrl() {
            return document.getElementById('baseUrl').value.replace(/\/$/, '');
        }

        async function testLogin() {
            const baseUrl = getBaseUrl();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                showResult('loginResult', 'æ­£åœ¨ç™»å½•...', 'info');
                
                const response = await fetch(`${baseUrl}/api/admin/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    // æå– session cookie
                    const setCookie = response.headers.get('set-cookie');
                    if (setCookie) {
                        const match = setCookie.match(/admin_session=([^;]+)/);
                        if (match) {
                            sessionCookie = match[1];
                        }
                    }
                    
                    showResult('loginResult', `âœ… ç™»å½•æˆåŠŸ!\nå“åº”: ${JSON.stringify(data, null, 2)}\nSession: ${sessionCookie}`, 'success');
                } else {
                    showResult('loginResult', `âŒ ç™»å½•å¤±è´¥!\nçŠ¶æ€: ${response.status}\nå“åº”: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult('loginResult', `âŒ ç™»å½•é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function testLogout() {
            const baseUrl = getBaseUrl();

            try {
                showResult('loginResult', 'æ­£åœ¨ç™»å‡º...', 'info');
                
                const response = await fetch(`${baseUrl}/api/admin/logout`, {
                    method: 'POST',
                    headers: {
                        'Cookie': `admin_session=${sessionCookie}`
                    }
                });

                if (response.ok) {
                    sessionCookie = '';
                    showResult('loginResult', 'âœ… ç™»å‡ºæˆåŠŸ!', 'success');
                } else {
                    showResult('loginResult', `âŒ ç™»å‡ºå¤±è´¥! çŠ¶æ€: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('loginResult', `âŒ ç™»å‡ºé”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function apiRequest(endpoint) {
            const baseUrl = getBaseUrl();
            
            if (!sessionCookie) {
                showResult('apiResult', 'âŒ è¯·å…ˆç™»å½•!', 'error');
                return;
            }

            try {
                showResult('apiResult', `æ­£åœ¨è¯·æ±‚ ${endpoint}...`, 'info');
                
                const response = await fetch(`${baseUrl}${endpoint}`, {
                    headers: {
                        'Cookie': `admin_session=${sessionCookie}`
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    showResult('apiResult', `âœ… è¯·æ±‚æˆåŠŸ!\nç«¯ç‚¹: ${endpoint}\nå“åº”: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult('apiResult', `âŒ è¯·æ±‚å¤±è´¥!\nç«¯ç‚¹: ${endpoint}\nçŠ¶æ€: ${response.status}\nå“åº”: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult('apiResult', `âŒ è¯·æ±‚é”™è¯¯: ${error.message}`, 'error');
            }
        }

        function testStats() {
            apiRequest('/api/admin/stats');
        }

        function testCodes() {
            apiRequest('/api/admin/codes');
        }

        function testUsers() {
            apiRequest('/api/admin/users');
        }

        function testCheckins() {
            apiRequest('/api/admin/checkins');
        }

        async function testSearch() {
            const query = document.getElementById('searchQuery').value;
            apiRequest(`/api/admin/codes/search?q=${encodeURIComponent(query)}`);
        }

        // å¯†ç ç”Ÿæˆå·¥å…·ï¼ˆå¤åˆ¶è‡ª generate-admin-password.jsï¼‰
        function generateSalt() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 16; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        async function hashPassword(password, salt) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password + salt);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function generatePassword() {
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;

            if (!username || !password) {
                showResult('passwordResult', 'âŒ è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç !', 'error');
                return;
            }

            try {
                showResult('passwordResult', 'æ­£åœ¨ç”Ÿæˆå¯†ç å“ˆå¸Œ...', 'info');
                
                const salt = generateSalt();
                const hash = await hashPassword(password, salt);
                const now = new Date().toISOString();
                
                const sql = `INSERT INTO admins (username, password_hash, salt, email, created_at) VALUES ('${username}', '${hash}', '${salt}', 'admin@example.com', '${now}');`;
                
                const result = `âœ… å¯†ç å“ˆå¸Œç”ŸæˆæˆåŠŸ!

ç”¨æˆ·å: ${username}
å¯†ç : ${password}
ç›å€¼: ${salt}
å“ˆå¸Œ: ${hash}

SQL æ’å…¥è¯­å¥:
${sql}

Wrangler å‘½ä»¤:
wrangler d1 execute kyx-checkin-system --command="${sql}"`;
                
                showResult('passwordResult', result, 'success');
            } catch (error) {
                showResult('passwordResult', `âŒ ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
            }
        }

        function openLoginPage() {
            const baseUrl = getBaseUrl();
            const url = `${baseUrl}/login`;
            window.open(url, '_blank');
            showResult('pageResult', `âœ… å·²æ‰“å¼€ç™»å½•é¡µé¢: ${url}`, 'success');
        }

        function openAdminPage() {
            const baseUrl = getBaseUrl();
            const url = `${baseUrl}/`;
            window.open(url, '_blank');
            showResult('pageResult', `âœ… å·²æ‰“å¼€ç®¡ç†é¡µé¢: ${url}`, 'success');
        }

        // é¡µé¢åŠ è½½æ—¶çš„æç¤º
        window.addEventListener('load', function() {
            showResult('loginResult', 'ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ KYX ç®¡ç†åå°æµ‹è¯•å·¥å…·!\n\nè¯·å…ˆé…ç½®ç®¡ç†åå°åœ°å€ï¼Œç„¶åæµ‹è¯•ç™»å½•åŠŸèƒ½ã€‚', 'info');
        });
    </script>
</body>
</html>
