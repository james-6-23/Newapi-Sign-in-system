<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€šçŸ¥ä¿®å¤æµ‹è¯• - KYX ç­¾åˆ°ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/main.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: var(--color-bg-elevated);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border-primary);
        }
        
        .test-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--color-bg-secondary);
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border-secondary);
        }
        
        .test-title {
            font-size: var(--text-lg);
            font-weight: var(--font-semibold);
            margin-bottom: 1rem;
            color: var(--color-accent);
        }
        
        .test-description {
            color: var(--color-text-secondary);
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        
        .test-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .test-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            cursor: pointer;
            transition: all var(--transition-fast);
            color: white;
        }
        
        .test-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .btn-primary { background: #3b82f6; }
        .btn-success { background: #10b981; }
        .btn-warning { background: #f59e0b; }
        .btn-danger { background: #ef4444; }
        .btn-info { background: #06b6d4; }
        .btn-purple { background: #8b5cf6; }
        
        .status-display {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--color-bg-primary);
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border-primary);
            font-family: monospace;
            font-size: var(--text-sm);
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--color-accent);
            text-decoration: none;
            margin-bottom: 2rem;
            transition: color var(--transition-fast);
        }
        
        .back-link:hover {
            color: var(--color-accent-hover);
        }
    </style>
</head>
<body>
    <div class="test-container">
        <a href="index.html" class="back-link">
            â† è¿”å›ä¸»é¡µ
        </a>
        
        <h1 style="text-align: center; margin-bottom: 2rem; color: var(--color-text-primary);">
            ğŸ”§ é€šçŸ¥ç³»ç»Ÿä¿®å¤æµ‹è¯•
        </h1>
        
        <!-- é€šçŸ¥çŠ¶æ€ç®¡ç†æµ‹è¯• -->
        <div class="test-section">
            <div class="test-title">ğŸ“‹ é€šçŸ¥çŠ¶æ€ç®¡ç†</div>
            <div class="test-description">
                æµ‹è¯•é€šçŸ¥çŠ¶æ€çš„æŒä¹…åŒ–å­˜å‚¨å’Œé˜²é‡å¤æœºåˆ¶ã€‚è¿™äº›åŠŸèƒ½ç¡®ä¿ç³»ç»Ÿèµ é€å¼¹çª—åªæ˜¾ç¤ºä¸€æ¬¡ã€‚
            </div>
            <div class="test-buttons">
                <button class="test-btn btn-info" onclick="window.checkNotificationState?.()">
                    æ£€æŸ¥é€šçŸ¥çŠ¶æ€
                </button>
                <button class="test-btn btn-danger" onclick="window.clearNotificationState?.()">
                    æ¸…é™¤é€šçŸ¥çŠ¶æ€
                </button>
                <button class="test-btn btn-warning" onclick="showLocalStorageInfo()">
                    æŸ¥çœ‹å­˜å‚¨ä¿¡æ¯
                </button>
            </div>
            <div class="status-display" id="notificationStatus">ç­‰å¾…æ“ä½œ...</div>
        </div>
        
        <!-- APIæ•°æ®ä¸€è‡´æ€§æµ‹è¯• -->
        <div class="test-section">
            <div class="test-title">ğŸ” APIæ•°æ®ä¸€è‡´æ€§</div>
            <div class="test-description">
                éªŒè¯é€šçŸ¥APIå’Œå…‘æ¢ç è®°å½•APIè¿”å›çš„æ•°æ®æ˜¯å¦ä¸€è‡´ï¼Œç¡®ä¿å¼¹çª—æ˜¾ç¤ºçš„å…‘æ¢ç ä¸åˆ—è¡¨ä¸­çš„åŒ¹é…ã€‚
            </div>
            <div class="test-buttons">
                <button class="test-btn btn-primary" onclick="window.validateAPIData?.()">
                    éªŒè¯APIæ•°æ®
                </button>
                <button class="test-btn btn-success" onclick="window.forceRefreshCodes?.()">
                    å¼ºåˆ¶åˆ·æ–°å…‘æ¢ç 
                </button>
                <button class="test-btn btn-info" onclick="testAPIConsistency()">
                    è¯¦ç»†ä¸€è‡´æ€§æ£€æŸ¥
                </button>
            </div>
            <div class="status-display" id="apiStatus">ç­‰å¾…æ“ä½œ...</div>
        </div>
        
        <!-- å¼¹çª—æµ‹è¯• -->
        <div class="test-section">
            <div class="test-title">ğŸ å¼¹çª—åŠŸèƒ½æµ‹è¯•</div>
            <div class="test-description">
                æµ‹è¯•ç³»ç»Ÿèµ é€å¼¹çª—çš„æ˜¾ç¤ºã€å…³é—­å’Œæ•°æ®åˆ·æ–°åŠŸèƒ½ã€‚
            </div>
            <div class="test-buttons">
                <button class="test-btn btn-purple" onclick="window.testGiftModal?.()">
                    æµ‹è¯•èµ é€å¼¹çª—
                </button>
                <button class="test-btn btn-success" onclick="simulateNotification()">
                    æ¨¡æ‹Ÿé€šçŸ¥å¤„ç†
                </button>
                <button class="test-btn btn-warning" onclick="testDuplicatePrevention()">
                    æµ‹è¯•é˜²é‡å¤æœºåˆ¶
                </button>
            </div>
            <div class="status-display" id="modalStatus">ç­‰å¾…æ“ä½œ...</div>
        </div>
        
        <!-- ç»¼åˆè°ƒè¯• -->
        <div class="test-section">
            <div class="test-title">ğŸ› ç»¼åˆè°ƒè¯•</div>
            <div class="test-description">
                ç»¼åˆè°ƒè¯•åŠŸèƒ½ï¼ŒæŸ¥çœ‹åº”ç”¨çŠ¶æ€å’Œæ•°æ®æµã€‚
            </div>
            <div class="test-buttons">
                <button class="test-btn btn-warning" onclick="window.debugDataState?.()">
                    è°ƒè¯•æ•°æ®çŠ¶æ€
                </button>
                <button class="test-btn btn-info" onclick="showAppState()">
                    æ˜¾ç¤ºåº”ç”¨çŠ¶æ€
                </button>
                <button class="test-btn btn-success" onclick="runFullDiagnostic()">
                    å®Œæ•´è¯Šæ–­
                </button>
            </div>
            <div class="status-display" id="debugStatus">ç­‰å¾…æ“ä½œ...</div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/app.js"></script>
    
    <script>
        // æ˜¾ç¤ºlocalStorageä¿¡æ¯
        function showLocalStorageInfo() {
            const status = document.getElementById('notificationStatus');
            try {
                const processedNotifications = localStorage.getItem('processedNotifications');
                const info = {
                    'processedNotifications': processedNotifications ? JSON.parse(processedNotifications) : null,
                    'localStorageå¤§å°': JSON.stringify(localStorage).length + ' å­—ç¬¦',
                    'å­˜å‚¨é¡¹æ•°é‡': localStorage.length
                };
                status.textContent = JSON.stringify(info, null, 2);
            } catch (error) {
                status.textContent = 'è·å–å­˜å‚¨ä¿¡æ¯å¤±è´¥: ' + error.message;
            }
        }
        
        // æµ‹è¯•APIä¸€è‡´æ€§
        async function testAPIConsistency() {
            const status = document.getElementById('apiStatus');
            status.textContent = 'æ­£åœ¨æ£€æŸ¥APIä¸€è‡´æ€§...';
            
            try {
                // è¿™é‡Œä¼šè°ƒç”¨å·²æœ‰çš„validateAPIDataå‡½æ•°
                if (typeof window.validateAPIData === 'function') {
                    await window.validateAPIData();
                    status.textContent = 'APIä¸€è‡´æ€§æ£€æŸ¥å®Œæˆï¼Œè¯¦æƒ…è¯·æŸ¥çœ‹æ§åˆ¶å°';
                } else {
                    status.textContent = 'validateAPIDataå‡½æ•°æœªæ‰¾åˆ°';
                }
            } catch (error) {
                status.textContent = 'APIä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥: ' + error.message;
            }
        }
        
        // æ¨¡æ‹Ÿé€šçŸ¥å¤„ç†
        function simulateNotification() {
            const status = document.getElementById('modalStatus');
            const mockNotificationId = 'test_' + Date.now();
            
            status.textContent = `æ¨¡æ‹Ÿå¤„ç†é€šçŸ¥ID: ${mockNotificationId}`;
            
            // æ¨¡æ‹Ÿæ·»åŠ åˆ°å·²å¤„ç†åˆ—è¡¨
            if (typeof AppState !== 'undefined') {
                AppState.processedNotifications.add(mockNotificationId);
                status.textContent += '\nå·²æ·»åŠ åˆ°å¤„ç†åˆ—è¡¨';
                
                // ä¿å­˜åˆ°localStorage
                if (typeof window.saveProcessedNotifications === 'function') {
                    window.saveProcessedNotifications();
                    status.textContent += '\nå·²ä¿å­˜åˆ°localStorage';
                }
            }
        }
        
        // æµ‹è¯•é˜²é‡å¤æœºåˆ¶
        function testDuplicatePrevention() {
            const status = document.getElementById('modalStatus');
            const testId = 'duplicate_test_123';
            
            if (typeof AppState !== 'undefined') {
                const wasProcessed = AppState.processedNotifications.has(testId);
                
                if (!wasProcessed) {
                    AppState.processedNotifications.add(testId);
                    status.textContent = `é¦–æ¬¡å¤„ç†é€šçŸ¥ ${testId} - åº”è¯¥æ˜¾ç¤ºå¼¹çª—`;
                } else {
                    status.textContent = `é€šçŸ¥ ${testId} å·²å¤„ç†è¿‡ - ä¸åº”æ˜¾ç¤ºå¼¹çª—`;
                }
                
                // å†æ¬¡æµ‹è¯•
                setTimeout(() => {
                    const stillProcessed = AppState.processedNotifications.has(testId);
                    status.textContent += `\n\né‡å¤æ£€æŸ¥: ${stillProcessed ? 'âœ… é˜²é‡å¤æœºåˆ¶æ­£å¸¸' : 'âŒ é˜²é‡å¤æœºåˆ¶å¤±æ•ˆ'}`;
                }, 1000);
            } else {
                status.textContent = 'AppStateæœªå®šä¹‰ï¼Œæ— æ³•æµ‹è¯•';
            }
        }
        
        // æ˜¾ç¤ºåº”ç”¨çŠ¶æ€
        function showAppState() {
            const status = document.getElementById('debugStatus');
            
            if (typeof AppState !== 'undefined') {
                const state = {
                    user: AppState.user ? 'å·²ç™»å½•' : 'æœªç™»å½•',
                    hasCheckedIn: AppState.hasCheckedIn,
                    recentCodesCount: AppState.recentCodes?.length || 0,
                    processedNotificationsCount: AppState.processedNotifications?.size || 0,
                    showingAllCodes: AppState.showingAllCodes,
                    loading: AppState.loading
                };
                status.textContent = JSON.stringify(state, null, 2);
            } else {
                status.textContent = 'AppStateæœªå®šä¹‰';
            }
        }
        
        // å®Œæ•´è¯Šæ–­
        async function runFullDiagnostic() {
            const status = document.getElementById('debugStatus');
            status.textContent = 'æ­£åœ¨è¿è¡Œå®Œæ•´è¯Šæ–­...\n';
            
            const results = [];
            
            // 1. æ£€æŸ¥å…¨å±€å¯¹è±¡
            results.push('=== å…¨å±€å¯¹è±¡æ£€æŸ¥ ===');
            results.push(`AppState: ${typeof AppState !== 'undefined' ? 'âœ…' : 'âŒ'}`);
            results.push(`CONFIG: ${typeof CONFIG !== 'undefined' ? 'âœ…' : 'âŒ'}`);
            results.push(`utils: ${typeof utils !== 'undefined' ? 'âœ…' : 'âŒ'}`);
            
            // 2. æ£€æŸ¥å…³é”®å‡½æ•°
            results.push('\n=== å…³é”®å‡½æ•°æ£€æŸ¥ ===');
            const functions = ['checkNotifications', 'loadRecentCodes', 'showGiftModal', 'closeGiftModal'];
            functions.forEach(fn => {
                results.push(`${fn}: ${typeof window[fn] === 'function' ? 'âœ…' : 'âŒ'}`);
            });
            
            // 3. æ£€æŸ¥localStorage
            results.push('\n=== å­˜å‚¨çŠ¶æ€æ£€æŸ¥ ===');
            try {
                const stored = localStorage.getItem('processedNotifications');
                results.push(`localStorageå¯ç”¨: âœ…`);
                results.push(`å·²å¤„ç†é€šçŸ¥: ${stored ? JSON.parse(stored).length : 0} ä¸ª`);
            } catch (error) {
                results.push(`localStorageé”™è¯¯: âŒ ${error.message}`);
            }
            
            status.textContent = results.join('\n');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('é€šçŸ¥ä¿®å¤æµ‹è¯•é¡µé¢å·²åŠ è½½');
            
            // æ˜¾ç¤ºåˆå§‹çŠ¶æ€
            setTimeout(() => {
                showAppState();
                showLocalStorageInfo();
            }, 1000);
        });
    </script>
</body>
</html>
