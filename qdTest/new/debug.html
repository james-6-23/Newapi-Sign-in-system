<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•é¡µé¢ - KYX ç­¾åˆ°ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/main.css">
    <style>
        .debug-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: var(--color-bg-elevated);
            border-radius: var(--radius-xl);
            border: 1px solid var(--color-border-primary);
        }
        
        .debug-section {
            margin-bottom: 30px;
            padding: 20px;
            background: var(--color-bg-secondary);
            border-radius: var(--radius-lg);
        }
        
        .debug-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--color-accent);
        }
        
        .debug-info {
            font-family: monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .status-ok {
            color: var(--color-success);
        }
        
        .status-error {
            color: var(--color-error);
        }
        
        .debug-button {
            margin: 5px;
        }
        
        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background: var(--color-bg-primary);
            padding: 10px;
            border-radius: var(--radius-md);
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>ğŸ”§ è°ƒè¯•é¡µé¢</h1>
        <p>æ­¤é¡µé¢ç”¨äºè¯Šæ–­ç™»å½•å’ŒAPIè¿æ¥é—®é¢˜</p>
        
        <div class="debug-section">
            <div class="debug-title">1. é…ç½®ä¿¡æ¯</div>
            <div class="debug-info" id="configInfo">åŠ è½½ä¸­...</div>
        </div>
        
        <div class="debug-section">
            <div class="debug-title">2. Cookie çŠ¶æ€</div>
            <div class="debug-info" id="cookieInfo">æ£€æŸ¥ä¸­...</div>
        </div>
        
        <div class="debug-section">
            <div class="debug-title">3. API è¿æ¥æµ‹è¯•</div>
            <button class="btn btn-primary debug-button" onclick="testAPI()">æµ‹è¯• API è¿æ¥</button>
            <button class="btn btn-secondary debug-button" onclick="testAuth()">æµ‹è¯•è®¤è¯çŠ¶æ€</button>
            <button class="btn btn-warning debug-button" onclick="clearStorage()">æ¸…é™¤æœ¬åœ°å­˜å‚¨</button>
            <div class="debug-info" id="apiTestResult"></div>
        </div>
        
        <div class="debug-section">
            <div class="debug-title">4. æ§åˆ¶å°æ—¥å¿—</div>
            <div class="log-container" id="logContainer"></div>
        </div>
        
        <div class="debug-section">
            <div class="debug-title">5. å¿«é€Ÿå¯¼èˆª</div>
            <button class="btn btn-primary debug-button" onclick="window.location.href='login.html'">å‰å¾€ç™»å½•é¡µ</button>
            <button class="btn btn-secondary debug-button" onclick="window.location.href='index.html'">å‰å¾€ä¸»é¡µ</button>
            <button class="btn btn-ghost debug-button" onclick="window.location.href='admin.html'">å‰å¾€ç®¡ç†åå°</button>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script>
        // æ—¥å¿—æ”¶é›†
        const logs = [];
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        console.log = function(...args) {
            logs.push({ type: 'log', message: args.join(' '), time: new Date().toLocaleTimeString() });
            updateLogs();
            originalLog.apply(console, args);
        };
        
        console.error = function(...args) {
            logs.push({ type: 'error', message: args.join(' '), time: new Date().toLocaleTimeString() });
            updateLogs();
            originalError.apply(console, args);
        };
        
        console.warn = function(...args) {
            logs.push({ type: 'warn', message: args.join(' '), time: new Date().toLocaleTimeString() });
            updateLogs();
            originalWarn.apply(console, args);
        };
        
        function updateLogs() {
            const container = document.getElementById('logContainer');
            container.innerHTML = logs.map(log => {
                const color = log.type === 'error' ? 'var(--color-error)' : 
                             log.type === 'warn' ? 'var(--color-warning)' : 
                             'var(--color-text-primary)';
                return `<div style="color: ${color}">[${log.time}] ${log.message}</div>`;
            }).join('');
            container.scrollTop = container.scrollHeight;
        }
        
        // æ˜¾ç¤ºé…ç½®ä¿¡æ¯
        function showConfig() {
            const configInfo = document.getElementById('configInfo');
            configInfo.innerHTML = `
API Base URL: ${window.CONFIG.API_BASE_URL}
User Info Endpoint: ${window.CONFIG.API_ENDPOINTS.AUTH.USER_INFO}
Full URL: ${window.CONFIG.API_BASE_URL}${window.CONFIG.API_ENDPOINTS.AUTH.USER_INFO}
Current Location: ${window.location.href}
Protocol: ${window.location.protocol}
Hostname: ${window.location.hostname}
            `;
        }
        
        // æ˜¾ç¤ºCookieä¿¡æ¯
        function showCookies() {
            const cookieInfo = document.getElementById('cookieInfo');
            const cookies = document.cookie;
            if (cookies) {
                cookieInfo.innerHTML = `Cookies:\n${cookies.split(';').map(c => c.trim()).join('\n')}`;
            } else {
                cookieInfo.innerHTML = '<span class="status-error">æ²¡æœ‰æ‰¾åˆ°ä»»ä½•Cookie</span>';
            }
        }
        
        // æµ‹è¯•APIè¿æ¥
        async function testAPI() {
            const resultDiv = document.getElementById('apiTestResult');
            resultDiv.innerHTML = 'æµ‹è¯•ä¸­...';
            
            try {
                console.log('å¼€å§‹æµ‹è¯•APIè¿æ¥...');
                const testUrl = window.CONFIG.API_BASE_URL + '/api/user';
                console.log('æµ‹è¯•URL:', testUrl);
                
                const response = await fetch(testUrl, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('å“åº”çŠ¶æ€:', response.status);
                const data = await response.json();
                console.log('å“åº”æ•°æ®:', data);
                
                resultDiv.innerHTML = `
<span class="${response.ok ? 'status-ok' : 'status-error'}">
çŠ¶æ€ç : ${response.status}
å“åº”: ${JSON.stringify(data, null, 2)}
</span>`;
            } catch (error) {
                console.error('APIæµ‹è¯•å¤±è´¥:', error);
                resultDiv.innerHTML = `<span class="status-error">é”™è¯¯: ${error.message}</span>`;
            }
        }
        
        // æµ‹è¯•è®¤è¯çŠ¶æ€
        async function testAuth() {
            const resultDiv = document.getElementById('apiTestResult');
            resultDiv.innerHTML = 'æ£€æŸ¥è®¤è¯çŠ¶æ€...';
            
            try {
                const user = await utils.checkAuth();
                if (user) {
                    resultDiv.innerHTML = `<span class="status-ok">å·²ç™»å½•ç”¨æˆ·: ${JSON.stringify(user, null, 2)}</span>`;
                } else {
                    resultDiv.innerHTML = '<span class="status-error">æœªç™»å½•</span>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="status-error">è®¤è¯æ£€æŸ¥å¤±è´¥: ${error.message}</span>`;
            }
        }
        
        // æ¸…é™¤æœ¬åœ°å­˜å‚¨
        function clearStorage() {
            localStorage.clear();
            sessionStorage.clear();
            document.cookie.split(";").forEach(function(c) { 
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
            });
            alert('å·²æ¸…é™¤æ‰€æœ‰æœ¬åœ°å­˜å‚¨å’ŒCookie');
            location.reload();
        }
        
        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        window.addEventListener('DOMContentLoaded', () => {
            showConfig();
            showCookies();
            console.log('è°ƒè¯•é¡µé¢å·²åŠ è½½');
        });
    </script>
</body>
</html>