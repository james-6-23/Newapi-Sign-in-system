<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KYX ç®¡ç†åå°ä¸“ä¸šæµ‹è¯•å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f0f;
            color: #ffffff;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
        }

        .panel h3 {
            color: #4285f4;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 4px;
            font-size: 14px;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #3367d6;
        }

        .btn.success {
            background: #34a853;
        }

        .btn.danger {
            background: #ea4335;
        }

        .btn.warning {
            background: #fbbc04;
            color: #000;
        }

        .status {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 8px;
        }

        .status.pending {
            background: #333;
            color: #999;
        }

        .status.success {
            background: #1e4620;
            color: #4caf50;
        }

        .status.error {
            background: #4a1e1e;
            color: #f44336;
        }

        .result {
            background: #0f0f0f;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 12px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-value {
            font-weight: bold;
            color: #4285f4;
        }

        input {
            background: #0f0f0f;
            border: 1px solid #333;
            color: white;
            padding: 8px;
            border-radius: 4px;
            margin: 4px;
            width: 120px;
        }

        .progress {
            background: #333;
            border-radius: 4px;
            height: 8px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-bar {
            background: #4285f4;
            height: 100%;
            transition: width 0.3s ease;
        }

        .log {
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 11px;
        }

        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }

        .log-entry.info {
            color: #4285f4;
        }

        .log-entry.success {
            color: #34a853;
        }

        .log-entry.error {
            color: #ea4335;
        }

        .log-entry.warning {
            color: #fbbc04;
        }

        .full-width {
            grid-column: 1 / -1;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ KYX ç®¡ç†åå°ä¸“ä¸šæµ‹è¯•å·¥å…·</h1>
            <p>ğŸŒ æµ‹è¯•åœ°å€: <strong id="testUrl">https://kyxsgiadmin.kyxjames23.workers.dev/</strong></p>
            <p>ğŸ“‹ ç½‘ç«™ç±»å‹: <strong>ä¸“ç”¨ç®¡ç†åå°</strong> (æ— éœ€ /admin è·¯å¾„)</p>
            <div class="progress">
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
            <p id="progressText">å‡†å¤‡å¼€å§‹æµ‹è¯•...</p>
        </div>

        <div class="grid">
            <div class="panel">
                <h3>ğŸŒ è¿æ¥æµ‹è¯•</h3>
                <button class="btn" onclick="testConnection()">æµ‹è¯•æœåŠ¡å™¨è¿æ¥</button>
                <span id="connectionStatus" class="status pending">å¾…æµ‹è¯•</span>
                <br>
                <button class="btn" onclick="testCORS()">æµ‹è¯•è·¨åŸŸè®¾ç½®</button>
                <span id="corsStatus" class="status pending">å¾…æµ‹è¯•</span>
                <div id="connectionResult" class="result"></div>
            </div>

            <div class="panel">
                <h3>ğŸ” è®¤è¯æµ‹è¯•</h3>
                <input type="text" id="username" placeholder="ç”¨æˆ·å" value="admin">
                <input type="password" id="password" placeholder="å¯†ç " value="admin123">
                <br>
                <button class="btn" onclick="testLogin()">ç™»å½•æµ‹è¯•</button>
                <span id="loginStatus" class="status pending">å¾…æµ‹è¯•</span>
                <div id="loginResult" class="result"></div>
            </div>

            <div class="panel">
                <h3>ğŸ“Š APIç«¯ç‚¹æµ‹è¯•</h3>
                <button class="btn" onclick="testDashboard()">ä»ªè¡¨ç›˜</button>
                <span id="dashboardStatus" class="status pending">å¾…æµ‹è¯•</span>
                <br>
                <button class="btn" onclick="testCodes()">å…‘æ¢ç </button>
                <span id="codesStatus" class="status pending">å¾…æµ‹è¯•</span>
                <br>
                <button class="btn" onclick="testUsers()">ç”¨æˆ·</button>
                <span id="usersStatus" class="status pending">å¾…æµ‹è¯•</span>
                <br>
                <button class="btn" onclick="testCheckins()">ç­¾åˆ°</button>
                <span id="checkinsStatus" class="status pending">å¾…æµ‹è¯•</span>
                <div id="apiResult" class="result"></div>
            </div>

            <div class="panel">
                <h3>âš¡ åŠŸèƒ½æµ‹è¯•</h3>
                <button class="btn" onclick="testGenerate()">ç”Ÿæˆå…‘æ¢ç </button>
                <span id="generateStatus" class="status pending">å¾…æµ‹è¯•</span>
                <br>
                <button class="btn" onclick="testSearch()">æœç´¢åŠŸèƒ½</button>
                <span id="searchStatus" class="status pending">å¾…æµ‹è¯•</span>
                <br>
                <button class="btn" onclick="testDebugMode()">è°ƒè¯•æ¨¡å¼</button>
                <span id="debugStatus" class="status pending">å¾…æµ‹è¯•</span>
                <br>
                <button class="btn" onclick="testPageAccess()">é¡µé¢è®¿é—®</button>
                <span id="pageAccessStatus" class="status pending">å¾…æµ‹è¯•</span>
                <div id="functionResult" class="result"></div>
            </div>

            <div class="panel full-width">
                <h3>ğŸ“ˆ æµ‹è¯•ç»Ÿè®¡</h3>
                <div class="grid" style="grid-template-columns: repeat(4, 1fr); gap: 10px;">
                    <div class="metric">
                        <span>æ€»æµ‹è¯•é¡¹</span>
                        <span class="metric-value" id="totalTests">0</span>
                    </div>
                    <div class="metric">
                        <span>é€šè¿‡</span>
                        <span class="metric-value" id="passedTests" style="color: #34a853;">0</span>
                    </div>
                    <div class="metric">
                        <span>å¤±è´¥</span>
                        <span class="metric-value" id="failedTests" style="color: #ea4335;">0</span>
                    </div>
                    <div class="metric">
                        <span>æˆåŠŸç‡</span>
                        <span class="metric-value" id="successRate">0%</span>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h3>ğŸš€ å¿«é€Ÿæ“ä½œ</h3>
                <button class="btn success" onclick="runAllTests()">ğŸ”„ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
                <button class="btn" onclick="quickHealthCheck()">âš¡ å¿«é€Ÿå¥åº·æ£€æŸ¥</button>
                <br>
                <button class="btn warning" onclick="openAdminPanel()">ğŸŒ æ‰“å¼€ç®¡ç†åå°</button>
                <button class="btn" onclick="openLoginPage()">ğŸ” æ‰“å¼€ç™»å½•é¡µé¢</button>
                <br>
                <button class="btn" onclick="exportReport()">ğŸ“„ å¯¼å‡ºæŠ¥å‘Š</button>
                <button class="btn danger" onclick="clearResults()">ğŸ§¹ æ¸…é™¤ç»“æœ</button>
            </div>

            <div class="panel">
                <h3>ğŸ“ å®æ—¶æ—¥å¿—</h3>
                <div id="testLog" class="log"></div>
            </div>
        </div>
    </div>

    <script>
        const ADMIN_BASE_URL = 'https://kyxsgiadmin.kyxjames23.workers.dev';
        const API_BASE_URL = 'https://kyxsgiadmin.kyxjames23.workers.dev/api/admin';

        let testResults = {};
        let testLog = [];
        let currentTestIndex = 0;
        let totalTests = 0;

        // æµ‹è¯•é…ç½®
        const TEST_CONFIG = {
            timeout: 10000, // 10ç§’è¶…æ—¶
            retryCount: 2,   // é‡è¯•æ¬¡æ•°
            delay: 500       // æµ‹è¯•é—´éš”
        };

        // åˆå§‹åŒ–
        document.getElementById('testUrl').textContent = ADMIN_BASE_URL;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] ${message}`;
            testLog.push({ timestamp, message, type });

            const logElement = document.getElementById('testLog');
            const entryElement = document.createElement('div');
            entryElement.className = `log-entry ${type}`;
            entryElement.textContent = entry;
            logElement.appendChild(entryElement);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus(id, success) {
            const element = document.getElementById(id);
            element.className = 'status ' + (success ? 'success' : 'error');
            element.textContent = success ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥';
        }

        function updateProgress() {
            const total = Object.keys(testResults).length;
            const completed = Object.values(testResults).filter(r => r !== null).length;
            const passed = Object.values(testResults).filter(r => r === true).length;
            const failed = Object.values(testResults).filter(r => r === false).length;

            const progressPercent = total > 0 ? (completed / total) * 100 : 0;
            const successRate = completed > 0 ? (passed / completed) * 100 : 0;

            document.getElementById('progressBar').style.width = progressPercent + '%';
            document.getElementById('progressText').textContent =
                `æµ‹è¯•è¿›åº¦: ${completed}/${total} (${progressPercent.toFixed(1)}%)`;

            document.getElementById('totalTests').textContent = total;
            document.getElementById('passedTests').textContent = passed;
            document.getElementById('failedTests').textContent = failed;
            document.getElementById('successRate').textContent = successRate.toFixed(1) + '%';
        }

        async function makeRequest(url, options = {}) {
            // æ„å»ºå®Œæ•´URL
            let fullUrl;
            if (url.startsWith('http')) {
                fullUrl = url;
            } else if (url.startsWith('/api/admin/')) {
                fullUrl = ADMIN_BASE_URL + url;
            } else {
                fullUrl = API_BASE_URL + url;
            }

            const startTime = Date.now();

            try {
                log(`ğŸ”„ è¯·æ±‚: ${options.method || 'GET'} ${fullUrl}`, 'info');

                const response = await fetch(fullUrl, {
                    mode: 'cors',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                const duration = Date.now() - startTime;
                const text = await response.text();

                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    data = {
                        error: 'Invalid JSON',
                        text: text,
                        contentType: response.headers.get('content-type')
                    };
                }

                log(`ğŸ“¡ å“åº”: ${response.status} (${duration}ms)`, response.ok ? 'success' : 'error');

                return {
                    ok: response.ok,
                    status: response.status,
                    data: data,
                    duration: duration,
                    url: fullUrl
                };
            } catch (error) {
                const duration = Date.now() - startTime;
                log(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                return { ok: false, error: error.message, duration: duration, url: fullUrl };
            }
        }

        // æµ‹è¯•å‡½æ•°
        async function testConnection() {
            testResults.connection = null;
            updateProgress();

            try {
                const startTime = Date.now();
                const result = await fetch(ADMIN_BASE_URL, { method: 'HEAD', mode: 'cors' });
                const duration = Date.now() - startTime;

                testResults.connection = result.ok;
                updateStatus('connectionStatus', result.ok);

                const details = `çŠ¶æ€: ${result.status}\nå“åº”æ—¶é—´: ${duration}ms\næœåŠ¡å™¨: ${result.headers.get('server') || 'æœªçŸ¥'}`;
                document.getElementById('connectionResult').textContent = details;

                log(`æœåŠ¡å™¨è¿æ¥æµ‹è¯•: ${result.ok ? 'æˆåŠŸ' : 'å¤±è´¥'} (${duration}ms)`, result.ok ? 'success' : 'error');
            } catch (error) {
                testResults.connection = false;
                updateStatus('connectionStatus', false);
                document.getElementById('connectionResult').textContent = `è¿æ¥å¤±è´¥: ${error.message}`;
                log(`æœåŠ¡å™¨è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
            updateProgress();
        }

        async function testCORS() {
            testResults.cors = null;
            updateProgress();

            try {
                const result = await makeRequest('/api/admin/stats');
                testResults.cors = result.ok || result.status === 401;
                updateStatus('corsStatus', testResults.cors);

                const details = `CORSæµ‹è¯•: ${testResults.cors ? 'é€šè¿‡' : 'å¤±è´¥'}\nçŠ¶æ€ç : ${result.status}\nè¯·æ±‚URL: ${result.url}`;
                document.getElementById('connectionResult').textContent = details;

                log(`CORSæµ‹è¯•: ${testResults.cors ? 'é€šè¿‡' : 'å¤±è´¥'}`, testResults.cors ? 'success' : 'error');
            } catch (error) {
                testResults.cors = false;
                updateStatus('corsStatus', false);
                log(`CORSæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
            updateProgress();
        }

        async function testLogin() {
            testResults.login = null;
            updateProgress();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const result = await makeRequest('/api/admin/login', {
                method: 'POST',
                body: JSON.stringify({ username, password })
            });

            testResults.login = result.ok && result.data && result.data.success;
            updateStatus('loginStatus', testResults.login);

            const details = testResults.login ?
                `âœ… ç™»å½•æˆåŠŸ\nç”¨æˆ·: ${username}\nå“åº”æ—¶é—´: ${result.duration}ms\nè¯·æ±‚URL: ${result.url}` :
                `âŒ ç™»å½•å¤±è´¥\né”™è¯¯: ${result.error || result.data?.message || 'æœªçŸ¥é”™è¯¯'}\nè¯·æ±‚URL: ${result.url}`;

            document.getElementById('loginResult').textContent = details;
            log(`ç™»å½•æµ‹è¯•: ${testResults.login ? 'æˆåŠŸ' : 'å¤±è´¥'}`, testResults.login ? 'success' : 'error');
            updateProgress();
        }

        async function testDashboard() {
            testResults.dashboard = null;
            updateProgress();

            const result = await makeRequest('/api/admin/stats');
            testResults.dashboard = result.ok && result.data && result.data.success;
            updateStatus('dashboardStatus', testResults.dashboard);

            const details = testResults.dashboard ?
                `âœ… ä»ªè¡¨ç›˜æ•°æ®åŠ è½½æˆåŠŸ\nå“åº”æ—¶é—´: ${result.duration}ms\nç»Ÿè®¡é¡¹: ${Object.keys(result.data.stats || {}).length}` :
                `âŒ ä»ªè¡¨ç›˜åŠ è½½å¤±è´¥\né”™è¯¯: ${result.error || result.data?.message || 'æœªçŸ¥é”™è¯¯'}`;

            document.getElementById('apiResult').textContent = details;
            log(`ä»ªè¡¨ç›˜æµ‹è¯•: ${testResults.dashboard ? 'æˆåŠŸ' : 'å¤±è´¥'}`, testResults.dashboard ? 'success' : 'error');
            updateProgress();
        }

        async function testCodes() {
            testResults.codes = null;
            updateProgress();

            const result = await makeRequest('/api/admin/codes?page=1&limit=5');
            testResults.codes = result.ok && result.data && result.data.success;
            updateStatus('codesStatus', testResults.codes);

            const details = testResults.codes ?
                `âœ… å…‘æ¢ç æ•°æ®åŠ è½½æˆåŠŸ\nå“åº”æ—¶é—´: ${result.duration}ms\næ•°é‡: ${result.data.codes?.length || 0}` :
                `âŒ å…‘æ¢ç åŠ è½½å¤±è´¥\né”™è¯¯: ${result.error || result.data?.message || 'æœªçŸ¥é”™è¯¯'}`;

            document.getElementById('apiResult').textContent = details;
            log(`å…‘æ¢ç æµ‹è¯•: ${testResults.codes ? 'æˆåŠŸ' : 'å¤±è´¥'}`, testResults.codes ? 'success' : 'error');
            updateProgress();
        }

        async function testUsers() {
            testResults.users = null;
            updateProgress();

            const result = await makeRequest('/api/admin/users?page=1&limit=5');
            testResults.users = result.ok && result.data && result.data.success;
            updateStatus('usersStatus', testResults.users);

            const details = testResults.users ?
                `âœ… ç”¨æˆ·æ•°æ®åŠ è½½æˆåŠŸ\nå“åº”æ—¶é—´: ${result.duration}ms\næ•°é‡: ${result.data.users?.length || 0}` :
                `âŒ ç”¨æˆ·æ•°æ®åŠ è½½å¤±è´¥\né”™è¯¯: ${result.error || result.data?.message || 'æœªçŸ¥é”™è¯¯'}`;

            document.getElementById('apiResult').textContent = details;
            log(`ç”¨æˆ·æµ‹è¯•: ${testResults.users ? 'æˆåŠŸ' : 'å¤±è´¥'}`, testResults.users ? 'success' : 'error');
            updateProgress();
        }

        async function testCheckins() {
            testResults.checkins = null;
            updateProgress();

            const result = await makeRequest('/api/admin/checkins?page=1&limit=5');
            testResults.checkins = result.ok && result.data && result.data.success;
            updateStatus('checkinsStatus', testResults.checkins);

            const details = testResults.checkins ?
                `âœ… ç­¾åˆ°æ•°æ®åŠ è½½æˆåŠŸ\nå“åº”æ—¶é—´: ${result.duration}ms\næ•°é‡: ${result.data.checkins?.length || 0}` :
                `âŒ ç­¾åˆ°æ•°æ®åŠ è½½å¤±è´¥\né”™è¯¯: ${result.error || result.data?.message || 'æœªçŸ¥é”™è¯¯'}`;

            document.getElementById('apiResult').textContent = details;
            log(`ç­¾åˆ°æµ‹è¯•: ${testResults.checkins ? 'æˆåŠŸ' : 'å¤±è´¥'}`, testResults.checkins ? 'success' : 'error');
            updateProgress();
        }

        async function testGenerate() {
            testResults.generate = null;
            updateProgress();

            const result = await makeRequest('/api/admin/codes/generate', {
                method: 'POST',
                body: JSON.stringify({ count: 2, amount: 5.00, adminId: 1 })
            });

            testResults.generate = result.ok && result.data && result.data.success;
            updateStatus('generateStatus', testResults.generate);

            const details = testResults.generate ?
                `âœ… å…‘æ¢ç ç”ŸæˆæˆåŠŸ\nå“åº”æ—¶é—´: ${result.duration}ms\næ¶ˆæ¯: ${result.data.message}` :
                `âŒ å…‘æ¢ç ç”Ÿæˆå¤±è´¥\né”™è¯¯: ${result.error || result.data?.message || 'æœªçŸ¥é”™è¯¯'}`;

            document.getElementById('functionResult').textContent = details;
            log(`ç”Ÿæˆæµ‹è¯•: ${testResults.generate ? 'æˆåŠŸ' : 'å¤±è´¥'}`, testResults.generate ? 'success' : 'error');
            updateProgress();
        }

        async function testSearch() {
            testResults.search = null;
            updateProgress();

            const result = await makeRequest('/api/admin/codes/search?q=TEST');
            testResults.search = result.ok && result.data && result.data.success;
            updateStatus('searchStatus', testResults.search);

            const details = testResults.search ?
                `âœ… æœç´¢åŠŸèƒ½æ­£å¸¸\nå“åº”æ—¶é—´: ${result.duration}ms\nç»“æœ: ${result.data.codes?.length || 0}` :
                `âŒ æœç´¢åŠŸèƒ½å¤±è´¥\né”™è¯¯: ${result.error || result.data?.message || 'æœªçŸ¥é”™è¯¯'}`;

            document.getElementById('functionResult').textContent = details;
            log(`æœç´¢æµ‹è¯•: ${testResults.search ? 'æˆåŠŸ' : 'å¤±è´¥'}`, testResults.search ? 'success' : 'error');
            updateProgress();
        }

        async function testDebugMode() {
            testResults.debug = null;
            updateProgress();

            const result = await makeRequest('/api/admin/codes?debug=true');
            testResults.debug = result.ok && result.data && result.data.debug;
            updateStatus('debugStatus', testResults.debug);

            const details = testResults.debug ?
                `âœ… è°ƒè¯•æ¨¡å¼æ­£å¸¸\nå“åº”æ—¶é—´: ${result.duration}ms\nè°ƒè¯•æ•°æ®: å¯ç”¨` :
                `âŒ è°ƒè¯•æ¨¡å¼å¤±è´¥\né”™è¯¯: ${result.error || 'æ— è°ƒè¯•æ•°æ®'}`;

            document.getElementById('functionResult').textContent = details;
            log(`è°ƒè¯•æ¨¡å¼æµ‹è¯•: ${testResults.debug ? 'æˆåŠŸ' : 'å¤±è´¥'}`, testResults.debug ? 'success' : 'error');
            updateProgress();
        }

        async function testPageAccess() {
            testResults.pageAccess = null;
            updateProgress();

            try {
                // æµ‹è¯•ä¸»é¡µè®¿é—®
                const mainPageResult = await fetch(ADMIN_BASE_URL, {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'include'
                });

                const mainPageOk = mainPageResult.ok;
                const contentType = mainPageResult.headers.get('content-type');
                const isHTML = contentType && contentType.includes('text/html');

                // æµ‹è¯•ç™»å½•é¡µé¢è®¿é—®
                const loginPageResult = await fetch(ADMIN_BASE_URL + '/login', {
                    method: 'GET',
                    mode: 'cors'
                });

                const loginPageOk = loginPageResult.ok;

                testResults.pageAccess = mainPageOk && isHTML && loginPageOk;
                updateStatus('pageAccessStatus', testResults.pageAccess);

                const details = `ä¸»é¡µè®¿é—®: ${mainPageOk ? 'âœ…' : 'âŒ'} (${mainPageResult.status})\n` +
                    `å†…å®¹ç±»å‹: ${contentType || 'æœªçŸ¥'}\n` +
                    `ç™»å½•é¡µé¢: ${loginPageOk ? 'âœ…' : 'âŒ'} (${loginPageResult.status})\n` +
                    `HTMLé¡µé¢: ${isHTML ? 'âœ…' : 'âŒ'}`;

                document.getElementById('functionResult').textContent = details;
                log(`é¡µé¢è®¿é—®æµ‹è¯•: ${testResults.pageAccess ? 'æˆåŠŸ' : 'å¤±è´¥'}`, testResults.pageAccess ? 'success' : 'error');

            } catch (error) {
                testResults.pageAccess = false;
                updateStatus('pageAccessStatus', false);
                document.getElementById('functionResult').textContent = `é¡µé¢è®¿é—®å¤±è´¥: ${error.message}`;
                log(`é¡µé¢è®¿é—®å¤±è´¥: ${error.message}`, 'error');
            }
            updateProgress();
        }

        async function runAllTests() {
            log('ğŸš€ å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...', 'info');

            const tests = [
                { name: 'æœåŠ¡å™¨è¿æ¥', func: testConnection },
                { name: 'CORSè®¾ç½®', func: testCORS },
                { name: 'é¡µé¢è®¿é—®', func: testPageAccess },
                { name: 'ç®¡ç†å‘˜ç™»å½•', func: testLogin },
                { name: 'ä»ªè¡¨ç›˜æ•°æ®', func: testDashboard },
                { name: 'å…‘æ¢ç æ•°æ®', func: testCodes },
                { name: 'ç”¨æˆ·æ•°æ®', func: testUsers },
                { name: 'ç­¾åˆ°æ•°æ®', func: testCheckins },
                { name: 'ç”ŸæˆåŠŸèƒ½', func: testGenerate },
                { name: 'æœç´¢åŠŸèƒ½', func: testSearch },
                { name: 'è°ƒè¯•æ¨¡å¼', func: testDebugMode }
            ];

            for (let i = 0; i < tests.length; i++) {
                const test = tests[i];
                log(`ğŸ“‹ [${i + 1}/${tests.length}] æµ‹è¯• ${test.name}...`, 'info');

                try {
                    await test.func();
                } catch (error) {
                    log(`âŒ æµ‹è¯• ${test.name} å‡ºç°å¼‚å¸¸: ${error.message}`, 'error');
                }

                // å»¶è¿Ÿä»¥é¿å…è¯·æ±‚è¿‡å¿«
                if (i < tests.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, TEST_CONFIG.delay));
                }
            }

            const passed = Object.values(testResults).filter(r => r === true).length;
            const total = Object.values(testResults).filter(r => r !== null).length;
            const failed = Object.values(testResults).filter(r => r === false).length;

            const successRate = total > 0 ? ((passed / total) * 100).toFixed(1) : 0;

            log(`ğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆ!`, 'success');
            log(`ğŸ“Š æµ‹è¯•ç»“æœ: ${passed}/${total} é€šè¿‡ (${successRate}%)`, 'info');

            if (failed > 0) {
                const failedTests = Object.entries(testResults)
                    .filter(([key, value]) => value === false)
                    .map(([key]) => key);
                log(`âŒ å¤±è´¥çš„æµ‹è¯•: ${failedTests.join(', ')}`, 'warning');
            }

            // ç”Ÿæˆæµ‹è¯•å»ºè®®
            if (passed === total) {
                log('âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ç®¡ç†åå°è¿è¡Œæ­£å¸¸', 'success');
            } else if (passed / total >= 0.8) {
                log('âš ï¸ å¤§éƒ¨åˆ†æµ‹è¯•é€šè¿‡ï¼Œå»ºè®®æ£€æŸ¥å¤±è´¥é¡¹', 'warning');
            } else {
                log('ğŸš¨ å¤šé¡¹æµ‹è¯•å¤±è´¥ï¼Œå»ºè®®å…¨é¢æ£€æŸ¥ç³»ç»Ÿ', 'error');
            }
        }

        function openAdminPanel() {
            window.open(ADMIN_BASE_URL, '_blank');
            log('ğŸŒ æ‰“å¼€ç®¡ç†åå°ä¸»é¡µ', 'info');
        }

        function openLoginPage() {
            window.open(ADMIN_BASE_URL + '/login', '_blank');
            log('ğŸ” æ‰“å¼€ç™»å½•é¡µé¢', 'info');
        }

        async function quickHealthCheck() {
            log('âš¡ å¼€å§‹å¿«é€Ÿå¥åº·æ£€æŸ¥...', 'info');

            const quickTests = [
                { name: 'æœåŠ¡å™¨è¿æ¥', func: testConnection },
                { name: 'é¡µé¢è®¿é—®', func: testPageAccess },
                { name: 'ç®¡ç†å‘˜ç™»å½•', func: testLogin }
            ];

            for (let i = 0; i < quickTests.length; i++) {
                const test = quickTests[i];
                log(`ğŸ” [${i + 1}/${quickTests.length}] æ£€æŸ¥ ${test.name}...`, 'info');

                try {
                    await test.func();
                } catch (error) {
                    log(`âŒ æ£€æŸ¥ ${test.name} å‡ºç°å¼‚å¸¸: ${error.message}`, 'error');
                }

                if (i < quickTests.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            }

            const quickResults = [
                testResults.connection,
                testResults.pageAccess,
                testResults.login
            ];

            const passed = quickResults.filter(r => r === true).length;
            const total = quickResults.filter(r => r !== null).length;

            if (passed === total) {
                log('âœ… å¿«é€Ÿå¥åº·æ£€æŸ¥é€šè¿‡ï¼ç³»ç»ŸåŸºæœ¬åŠŸèƒ½æ­£å¸¸', 'success');
            } else {
                log(`âš ï¸ å¿«é€Ÿå¥åº·æ£€æŸ¥å‘ç°é—®é¢˜ (${passed}/${total} é€šè¿‡)`, 'warning');
                log('ğŸ’¡ å»ºè®®è¿è¡Œå®Œæ•´æµ‹è¯•ä»¥è·å–è¯¦ç»†ä¿¡æ¯', 'info');
            }
        }

        function exportReport() {
            const report = {
                timestamp: new Date().toISOString(),
                testUrl: ADMIN_BASE_URL,
                results: testResults,
                log: testLog,
                summary: {
                    total: Object.keys(testResults).length,
                    passed: Object.values(testResults).filter(r => r === true).length,
                    failed: Object.values(testResults).filter(r => r === false).length
                }
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kyx-admin-test-report-${new Date().toISOString().slice(0, 19)}.json`;
            a.click();
            URL.revokeObjectURL(url);

            log('ğŸ“„ æµ‹è¯•æŠ¥å‘Šå·²å¯¼å‡º', 'success');
        }

        function clearResults() {
            testResults = {};
            testLog = [];
            document.getElementById('testLog').innerHTML = '';

            // é‡ç½®æ‰€æœ‰çŠ¶æ€
            document.querySelectorAll('.status').forEach(el => {
                el.className = 'status pending';
                el.textContent = 'å¾…æµ‹è¯•';
            });

            // æ¸…ç©ºç»“æœæ˜¾ç¤º
            document.querySelectorAll('.result').forEach(el => {
                el.textContent = '';
            });

            updateProgress();
            log('ğŸ§¹ æµ‹è¯•ç»“æœå·²æ¸…é™¤', 'info');
        }

        // åˆå§‹åŒ–è¿›åº¦
        updateProgress();
        log('ğŸ”§ KYX ç®¡ç†åå°æµ‹è¯•å·¥å…·å·²å°±ç»ª', 'success');
        log('ğŸ’¡ æç¤º: è¿™æ˜¯ä¸€ä¸ªä¸“ç”¨ç®¡ç†åå°ç½‘ç«™ï¼Œæ— éœ€ /admin è·¯å¾„', 'info');
        log('ğŸš€ å»ºè®®å…ˆè¿è¡Œ"å¿«é€Ÿå¥åº·æ£€æŸ¥"ï¼Œç„¶åæ ¹æ®éœ€è¦è¿è¡Œå®Œæ•´æµ‹è¯•', 'info');
    </script>
</body>

</html>